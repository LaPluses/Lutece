{% extends "base.html" %}

{% block extra_head %}
    {% load staticfiles %}
        <link href="{% static 'css/problem/problem_detail.css' %}" rel="stylesheet" />
{% endblock extra_head %}

{% block title %}
    <title> Lutece | {{prob.title}} </title>
{% endblock title %}

{% block content %}
    <div class = 'problem detail'>
        <div class = 'summary'>
            <h1 class = 'ui header'>{{prob.title}}</h1>
            <div class = 'limit'><b>TimeLimit: {{prob.time_limit}} Milliseconds</b></div>
            <div class = 'limit'><b>MemoryLimit: {{prob.memory_limit}} Megabytes</b></div>
            <div class = 'menu'>
                <div class = 'ui basic primary submit button'><i class = 'location arrow icon'></i><b>Submit</b></div>
                <div class = 'ui basic secondary status button'><i class = 'signal icon'></i><b>Status</b></div>
                {% if perms.problem.change_problem %}
                    <div class = 'ui basic orange edit button'><i class = 'edit icon'></i><b>Edit</b></div>
                {% endif %}
            </div>
        </div>
        <div class = 'body'>
            <p class = 'content'>{{prob.content|linebreaks}}</p>
            <h2 class= 'ui header'>Standard Input</h2>
            <p class = 'content'>{{prob.standard_input|linebreaks}}</p>
            <h2 class= 'ui header'>Standard Output</h2>
            <p class = 'content'>{{prob.standard_output|linebreaks}}</p>
            {% if  prob.constraints|length > 0  %}
                <h2 class='ui header'> Constraints </h2>
                <p class='content'>{{prob.constraints|linebreaks}}</p>
            {% endif%}

            <h2 class= 'ui header'>Sample</h2>
                <table class="ui table" >
                        <thead>
                            <tr>
                                <th> Input </th>
                                <th> Output </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for it in sample %}
                                <tr>
                                    <td>{{it.input_content|linebreaks}}</td>
                                    <td>{{it.output_content|linebreaks}}</td>
                                </tr>
                            {% endfor%}
                        </tbody>
                </table>
            {% if  prob.sample_explanation|length > 0  %}
                <h2 class='ui header'>Note</h2>
                <p class='content'>{{prob.sample_explanation|linebreaks}}</p>
            {% endif%}

            {% if  prob.resource|length > 0  %}
                <h2 class='ui header'>Resource</h2>
                <p class='content'>{{prob.resource}}</p>
            {% endif%}
        </div>

        <div id = "submit_modal" class="ui submit modal">
            <div class = 'ui middle aligned center header'>
                Submit
            </div>
            <textarea spellcheck = "false" id='code_textarea'>
#include <cstdio>
#include <algorithm>

using namespace std;

const int maxn = 1e5 + 50;

using ul = unsigned int;

int n , Q;
ul a[maxn];

namespace SegmentTree{
    struct Node{
        int l , r;
        pair < ul , ul > g;
        ul sum , lzy , pw;

        void Backup( pair < ul , ul > s ){
            g.first += s.first , g.second += s.first * lzy + s.second;
            pw += s.first * sum + s.second * ( r - l + 1 );
        }

        void Update( ul x ){
            if( l ^ r ) lzy += x;
            sum += x * ( r - l + 1 );
        }
    }tree[maxn << 2];

    void ReleaseLabel( int o ){
        tree[o << 1].Backup( tree[o].g );
        tree[o << 1 | 1].Backup( tree[o].g );
        tree[o].g = make_pair( 0 , 0 );
        if( tree[o].lzy ){
            tree[o << 1].Update( tree[o].lzy );
            tree[o << 1 | 1].Update( tree[o].lzy );
            tree[o].lzy = 0;
        }
    }

    void Maintain( int o ){
        tree[o].sum = tree[o << 1].sum + tree[o << 1 | 1].sum;
        tree[o].pw = tree[o << 1].pw + tree[o << 1 | 1].pw;
    }

    void Build( int l , int r , int o ){
        tree[o].l = l , tree[o].r = r;
        if( l < r ){
            int mid = l + r >> 1;
            Build( l , mid , o << 1 );
            Build( mid + 1 , r , o << 1 | 1 );
            Maintain( o );
        }else
            tree[o].sum = a[l];
    }

    void Backup( int ql , int qr , ul k , ul b , int o ){
        int l = tree[o].l , r = tree[o].r;
        if( ql <= l && r <= qr )
            tree[o].Backup( { k , b } );
        else{
            int mid = l + r >> 1;
            ReleaseLabel( o );
            if( ql <= mid )
                Backup( ql , qr , k , b , o << 1 );
            if( qr > mid )
                Backup( ql , qr , k , b , o << 1 | 1 );
            Maintain( o );
        }
    }

    void Modify( int ql , int qr , ul x , int o ){
        int l = tree[o].l , r = tree[o].r;
        if( ql <= l && r <= qr )
            tree[o].Update( x );
        else{
            int mid = l + r >> 1;
            ReleaseLabel( o );
            if( ql <= mid )
                Modify( ql , qr , x , o << 1 );
            if( qr > mid )
                Modify( ql , qr , x , o << 1 | 1 );
            Maintain( o );
        }
    }

    ul Query( int ql , int qr , int o ){
        int l = tree[o].l , r = tree[o].r;
        if( ql <= l && r <= qr )
            return tree[o].pw;
        else{
            int mid = l + r >> 1;
            ReleaseLabel( o );
            ul ret = 0;
            if( ql <= mid ) ret += Query( ql , qr , o << 1 );
            if( qr > mid ) ret += Query( ql , qr , o << 1 | 1 );
            Maintain( o );
            return ret;
        }
    }
};

int main( int argc , char * argv[] ){
    scanf( "%d%d" , & n , & Q );
    for(int i = 1 ; i <= n ; ++ i)
        scanf( "%u" , a + i );
    SegmentTree::Build( 1 , n , 1 );
    while( Q -- ){
        int type ;
        scanf( "%d" , & type );
        if( type == 1 ){
            int l , r;
            ul x;
            scanf( "%d%d%u" , & l , & r , & x );
            SegmentTree::Modify( l , r , x , 1 );
        }
        if( type == 2 ){
            int l , r;
            ul k , b;
            scanf( "%d%d%u%u" , & l , & r , & k , & b );
            SegmentTree::Backup( l , r , k , b , 1 );
        }
        if( type == 3 ){
            int l , r;
            scanf( "%d%d" , & l , & r );
            printf( "%u\n" , SegmentTree::Query( l , r , 1 ) );
        }
    }
    return 0;
}</textarea>
            <div id="bottom_menu">
                <div id = "languagelist" class="ui language selection dropdown">
                    <i class="dropdown icon"></i>
                    <div class="submit language text">{{support_lang.0}}</div>
                    <div class="menu">
                        {% for it in support_lang %}
                            <div class="item">{{it}}</div>
                        {% endfor %}
                    </div>
                </div>
                <div id = "code_submit_button"><i class = 'ui large secondary button'>Submit</i></div>
            </div>
        </div>
    </div>

    <script>

        $(document).ready(function(){
            $('.ui.language.dropdown')
                .dropdown()
            ;

            $('.problem.detail > .summary > .menu > .submit').click(function () {
                '{% if user.is_authenticated == True %}'
                    $('#submit_modal').modal('show');
                '{% else %}'
                    $('.login.modal' ).modal( 'show' );
                '{% endif %}'
            });
    
            $('.problem.detail > .summary > .menu > .edit').click(function () {
                window.location = '{% url "problem-edit-view" prob.problem_id %} ';
            });
    
            $('#code_submit_button > .button').click(function(){
                var code = $('#code_textarea')["0"].value;
                var lang = $("#languagelist")[0].innerText;
                //alert( "Submit code is " + code + " Lang is " + lang );
                $(this)
                    .addClass( 'loading disabled' )
                ;
                var problemid = '{{prob.problem_id}}';
                $.ajaxSetup({
                    data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                });
                $.post(
                    '{% url "submission-submit-solution" %}',
                    {
                        'problemid' : problemid,
                        'code' : code,
                        'language' : lang,
                    },
                    function(data,status){
                        if( status == 'success' ){
                            //alert(data.submission_id);
                        }
                        $('#code_submit_button > .button').
                            removeClass( 'loading disabled' )
                        ;
                    }
                )
            });                
        });
    </script>
{% endblock content %}