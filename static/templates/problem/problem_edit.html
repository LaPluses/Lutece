{% extends "base/base.html" %}

{% set active_page = 'Problem' %}

{% block extra_head %}
    <link href="{{ static('css/problem/problem_edit.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ static('/katex/dist/katex.min.js') }}"></script>
    <script type="text/javascript" src="{{ static('/katex/dist/contrib/auto-render.min.js') }}"></script>
    <link rel="stylesheet" href="{{ static('/katex/dist/katex.min.css') }}"/>
    <script type="text/javascript" src="{{ static('/markdown/dist/marked.min.js') }}"></script>
{% endblock extra_head %}

{% block title %}
    <title> Lutece | {{prob.title}} </title>
{% endblock title %}

{% block content %}
    <div class ='edit container'>
        <div class = 'ui grid'>

            <div class = 'row'>
                <div class = 'column aligned center'>
                    <h1 class="ui aligned center header">Problem {{ prob.problem_id }} </h1>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div class="ui large label">Title</div>
                    <div class = 'ui fluid input'>
                        <input id = 'title-input' type = "text" value = '{{ prob.title }}' maxlength = "64">
                    </div>
                </div>
            </div>
            
            <div class = 'row'>
                <div class = 'column'>
                    <div>
                        <label class="ui large label">Time Limit</label>
                    </div>
                    <div class = 'ui right labeled input'>
                        <input id = 'timelimit-input' type="number"  maxlength = "5" value = {{ prob.time_limit }} >
                        <div class="ui basic label">Milliseconds</div>
                    </div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div>
                        <label class="ui large label">Memory Limit</label>
                    </div>                
                    <div class = 'ui right labeled input'>
                        <input id = 'memorylimit-input' type="number" maxlength = "4" value = {{ prob.memory_limit }} >
                        <div class="ui basic label">Megabytes</div>
                    </div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div>
                        <label class="ui large label">CPUCore Limit</label>
                    </div>  
                    <div class = 'ui right labeled input'>
                        <input id = 'CPUCore-input' type="number" maxlength = "4" value = 1 disabled = "" >
                        <div class="ui basic label">Cores</div>
                    </div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div id = "visible-checkbox" class="ui toggle checkbox">
                        <input type="checkbox" tabindex="0" class="hidden">
                        <label> <b>Visible</b> </label>
                    </div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div id = "discussion-checkbox" class="ui toggle checkbox">
                        <input type="checkbox" tabindex="0" class="hidden">
                        <label> <b>Discussion</b> </label>
                    </div>
                </div>
            </div>



            <div class = 'row'>
                <div class = 'column'>
                    <div>
                        <label class="ui large label">TestCase</label>
                    </div>
                    <div class = 'ui right labeled input'>
                        <input id = 'case-number' type="number" maxlength = "4" value = {{ case_number }} disabled = "" >
                        <div class="ui basic label">Cases</div>
                    </div>
                </div>
            </div>


            <div class = 'row'>
                <div class = 'column'>
                    <form >
                        <input type = "file" name = 'data' id = "__upload" style = 'display:none'>
                        <div data-tooltip = "目前测试数据仅支持['.tar','.zip']压缩包,里面测试数据必须是每组'.in'对应每组'.out',不要有任何多余的文件." data-position="top left" id = 'upload-data-button' class = 'ui primary button' ><i class = 'upload icon'></i>Upload Data</div>
                    </form>
                </div>
            </div>

            <div class = 'row' id = 'upload-div' style = 'display:none'>
                <div class = 'column' >
                    <div class = "ui indicating progress" id = 'upload-progress' >
                        <div class="bar">
                            <div class="progress"></div>
                        </div>
                        <div class="label">Upload status</div>
                    </div>
                </div>
            </div>

            <div class = 'row' id = 'upload-error-div' style = 'display:none' >
                <div class = 'column'>
                    <div id = "upload-error-msg" class="ui negative message transition"></div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    
                    <div class="ui large label">Checker</div>
                    <div id = "checker-selection" class="ui fluid selection dropdown">
                        <i class="dropdown icon"></i>
                        <div class="submit language text">{{prob.checker}}: {{ checker[ prob.checker ] }}</div>
                        <div class="menu">
                            {% for key, value in checker.items() %}
                                <div class="item">{{ key }}: {{value}}</div>
                            {% endfor %}
                        </div>
                    </div>


                </div>
            </div>

            <div class = 'row'>


                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Content</div>
                        <textarea style = 'width:100%;height:400px;' id = "content-textarea" >{{ prob.content }}</textarea>
                    </div>
                </div>

                <div class ='eight wide column'>
                    <div class="ui large label">Content Preview</div>
                    <div id = "content-textarea-render" style = 'width:100%;height:auto;min-height:400px;margin-top:0;' class="ui render fluid container raised segment"></div>
                </div>

            </div>

            
            <div class = 'row'>

                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Standard Input</div>
                        <textarea style = 'width:100%;height:200px;' id = "standard_input-textarea">{{ prob.standard_input }}</textarea>
                    </div>
                </div>

                <div class = 'eight wide column'>
                    <div class="ui large label">Input Preview</div>
                    <div id = "standard_input-textarea-render" style = 'width:100%;height:auto;min-height:200px;margin-top:0;' class="ui render fluid container raised segment"></div>
                </div>

            </div>


            <div class = 'row'>

                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Standard Output</div>
                        <textarea style = 'width:100%;height:200px;' id = "standard_output-textarea">{{ prob.standard_output }}</textarea>
                    </div>
                </div>

                <div class = 'eight wide column'>
                    <div class="ui large label">Output Preview</div>
                    <div id = "standard_output-textarea-render" style = 'width:100%;height:auto;min-height:200px;margin-top:0;' class="ui render fluid container raised segment"></div>
                </div>

            </div>

            <div class = 'row'>
                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Constraints</div>
                        <textarea style = 'width:100%;height:200px;' id = "constraints-textarea">{{ prob.constraints }}</textarea>
                    </div>
                </div>
                <div class = 'eight wide column'>
                    <div class="ui large label">Constraints Preview</div>
                    <div id = "constraints-textarea-render" style = 'width:100%;height:auto;min-height:200px;margin-top:0;' class="ui render fluid container raised segment"></div>
                </div>
            </div>

            <h4 class="ui horizontal divider header"> <i class="tag icon"></i> Sample </h4> 

            <div class = 'row'>
                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Sample Input</div>
                    </div>
                </div>
                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Sample Output</div>
                    </div>
                </div>
            </div>


            <div class = 'row' id = 'sample_template' style = 'display:none;'>
                <div class = 'eight wide column'>
                    <div class = 'ui form' >
                        <a class="ui red ribbon label" onclick='$(this).parent().parent().parent().remove();'>Delete</a>
                        <textarea class = 'sample_input' style = 'width:100%;height:200px;'></textarea>
                    </div>
                </div>
                <div class = 'eight wide column' style='margin-top:auto;'>
                    <div class = 'ui form'>
                        <textarea class = 'sample_output' style = 'width:100%;height:200px;'></textarea>
                    </div>
                </div>
            </div>


            {% for x in sample %}

                <div class = 'row'>
                    <div class = 'eight wide column'>
                        <div class = 'ui form' >
                            <a class="ui red ribbon label" onclick='$(this).parent().parent().parent().remove();'>Delete</a>
                            <textarea class = 'sample_input' style = 'width:100%;height:200px;'>{{ x.input_content }}</textarea>
                        </div>
                    </div>
                    <div class = 'eight wide column' style='margin-top:auto;' >
                        <div class = 'ui form'>
                            <textarea class = 'sample_output' style = 'width:100%;height:200px;'>{{ x.output_content }}</textarea>
                        </div>
                    </div>
                </div>

            {% endfor %}

            <div class = 'row' id = 'AppendLastDOM' >
                <div class = 'four wide column'>
                    <div id = 'add-sample' class = 'ui secondary button'><i class = 'plus icon'></i>Add Sample</div>
                </div>
            </div>

            <div class="ui divider"></div>


            <div class = 'row'>
                <div class = 'eight wide column'>
                    <div class = 'ui form'>
                        <div class="ui large label">Note</div>
                        <textarea style = 'width:100%;height:200px;' id = "note-textarea">{{ prob.note }}</textarea>
                    </div>
                </div>
                <div class = 'eight wide column'>
                    <div class="ui large label">Note Preview</div>
                    <div id = "note-textarea-render" style = 'width:100%;height:auto;min-height:200px;margin-top:0;' class="ui render fluid container raised segment"></div>
                </div>
            </div>


            <div class = 'row'>
                <div class = 'column'>
                    <div class="ui large label">Resource</div>
                    <div class = 'ui fluid input'>
                        <input id = "resource" type="text" value = {{ prob.resource }} >
                    </div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div id = "form-error-msg" class="ui negative message transition hidden"></div>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'column'>
                    <div id = "submit-form" class = 'ui primary button'>Submit</div>
                </div>
            </div>

        </div>
    </div>

    <script>

        $(document).ready(function(){

            $('#visible-checkbox').checkbox();
            $('#discussion-checkbox').checkbox();


            {%  if prob.visible == True %}
                $('#visible-checkbox').checkbox( 'set checked' );
            {% endif %}
            {% if prob.discussion == True %}
                $('#discussion-checkbox').checkbox( 'set checked' );
            {% endif %}

            $('#checker-selection').dropdown();

            Pewview( 'content-textarea' , 'content-textarea-render' );
            Pewview( 'standard_input-textarea' , 'standard_input-textarea-render' );
            Pewview( 'standard_output-textarea' , 'standard_output-textarea-render' );
            Pewview( 'constraints-textarea' , 'constraints-textarea-render' );
            Pewview( 'note-textarea' , 'note-textarea-render' );
            renderMathInElement(
                document.body,
                {
                    delimiters : [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},                    
                        {left: "\\[", right: "\\]", display: true},
                        {left: "\\(", right: "\\)", display: false}
                    ]
            });

            $('#upload-data-button').click(function(){
                $('#__upload').click();
            });

            function progressHandlingFunction(e){
                if(e.lengthComputable){
                    $('#upload-progress').progress( 'set progress' , e.loaded );
                }
            }

            function upload_success(e){
                $("#upload-data-button").removeClass( 'disabled loading');
                if( e.status == false ){
                    $('#upload-progress').progress( 'set error' );
                    $("#upload-data-button").removeClass( 'primary' );
                    $("#upload-data-button").addClass( 'red' );
                    $('#upload-error-div').css( 'display' , 'block' );
                    $('#upload-error-msg')
                        .empty()
                        .removeClass( 'hidden' )
                        .append(get_error_msgText( e.error_list ))
                    ;
                }else{
                    $('#upload-progress').progress( 'set success' );
                    $('#case-number').val( e.case_number );
                }
            }

            function upload_error(e){
                $("#upload-data-button").removeClass( 'disabled loading primary');
                $("#upload-data-button").addClass( 'disabled red');
                alert( 'Uploaded error' );
            }

            $('#__upload').on( 'change' , function(){
                var file = $('#__upload')[0].files[0];
                var formData = new FormData();
                formData.append( 'data' , file );
                $.ajax({
                    url : '{{ url("problem-upload-data" , args = (prob.problem_id , ) ) }}',
                    async: true,
                    xhr: function() {  // custom xhr
                        $("#upload-data-button").removeClass( 'red' );
                        $("#upload-data-button").addClass( 'disabled loading primary')
                        $('#upload-error-div').css( 'display' , 'none' );
                        myXhr = $.ajaxSettings.xhr();
                        $('#upload-div').css( 'display' , 'block' );
                        $("#upload-progress").progress( 'set total' , file.size);
                        if(myXhr.upload){
                            myXhr.upload.addEventListener('progress',progressHandlingFunction, false);
                        }
                        return myXhr;
                    },
                    type : 'POST',
                    success:upload_success,
                    error:upload_error,
                    cache: false,
                    data : formData,
                    contentType: false,
                    processData: false
                });
            });

            $('#add-sample').click(function(){
                var ns = $('#sample_template').clone( true );
                ns.removeAttr( 'id' );
                ns.css( 'display' , 'flex' );
                $('#AppendLastDOM').before( ns );
            });

            $('#submit-form').click(function(){
                var title = $('#title-input').val();
                var timelimit = $('#timelimit-input').val();
                var memorylimit = $('#memorylimit-input').val();
                var checker = $("#checker-selection")[0].innerText.split(":")[0];
                var visible = $('#visible-checkbox').hasClass('checked');
                var discussion = $('#discussion-checkbox').hasClass('checked');
                var content = $('#content-textarea').val();
                var standard_input = $('#standard_input-textarea').val();
                var standard_output = $('#standard_output-textarea').val();
                var note = $('#note-textarea').val();
                var constraints = $('#constraints-textarea').val();
                var resource = $('#resource').val();
                var sample_input_all = $('.edit.container .sample_input');
                var sample_output_all = $('.edit.container .sample_output');
                var sample = new Array();
                for( let i = 0 ; i < sample_input_all.length ; ++ i){
                    let _in = $(sample_input_all[i]).val();
                    let _out = $(sample_output_all[i]).val();
                    let par = $(sample_input_all[i]).parent().parent().parent();
                    if( par.css('display') == 'none' ) continue;
                    sample.push( new Array( _in , _out ) );
                }
                $(this)
                    .addClass( 'loading disabled' )
                ;
                $.post(
                    '{{ url("problem-update" , args = (prob.problem_id , ) ) }}',
                    {
                        'csrfmiddlewaretoken' : '{{ csrf_token }}',
                        'title' : title,
                        'timelimit' : timelimit,
                        'memorylimit' : memorylimit,
                        'note' : note,
                        'checker' : checker,
                        'visible' : visible,
                        'content' : content,
                        'standard_input' : standard_input,
                        'standard_output' : standard_output,
                        'constraints' : constraints,
                        'discussion' : discussion,
                        'resource' : resource,
                        'sample' : JSON.stringify(sample),
                    },
                    function(data,status){
                        if( status == 'success'  && data.update_status == true ){
                            window.location = '{{ url("problem-detail" , args = ( prob.problem_id , ) )  }} ';
                        }else{
                            $('#submit-form')
                                .removeClass( 'loading disabled primary' )
                                .addClass('red')
                            ;
                            $('#form-error-msg')
                                .empty()
                                .removeClass( 'hidden' )
                                .append(get_error_msgText( data.error_list ))
                            ;
                        }
                    }
                )
            });
        });
    </script>
{% endblock content %}