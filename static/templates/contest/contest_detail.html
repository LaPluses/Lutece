{% extends "base/base.html" %}

{% block extra_head %}
    <script type="text/javascript" src="{{ static('/katex/dist/katex.min.js') }}"></script>
    <script type="text/javascript" src="{{ static('/katex/dist/contrib/auto-render.min.js') }}"></script>
    <link rel="stylesheet" href="{{ static('/katex/dist/katex.min.css') }}"/>
    <script type="text/javascript" src="{{ static('/markdown/dist/marked.min.js') }}"></script>    
{% endblock extra_head %}

{% block content %}
    <div class = 'contest detail'>
        <div class = 'ui one column grid'>

            <div class = 'column'>
                <h1 style = 'text-align:center'> {{ contest.title }} </h1>
            </div>

            <div class = 'column'>
                <div class = "ui indicating progress" id = 'runtime-progress' >
                    <div class = "bar">
                        <div class="progress"></div>
                    </div>
                    <div class = "label" style = 'font-size:16px;margin-top:10px;' >
                        <i class = '{{ conteststatus.value.icon }}' style = 'color:{{ conteststatus.value.color }};' ></i> <span style = 'color:{{ conteststatus.value.color }};'><b>{{ conteststatus.value.full }}</b><span id = 'time-show' ></span></span>
                    </div>
                </div>
            </div>

            <div class = 'column'>
                <div class="ui top attached tabular menu">
                    <a class="active item" data-tab="overview" id = 'tab-overview'ã€€>Overview</a>
                    <a class='item' data-tab='problem' id = 'tab-problem' >Problem</a>
                    <a class="item" data-tab="clarification" id ='tab-clarification'>Clarification</a>
                    <a class="item" data-tab="submission" id = 'tab-submission' >Submission</a>
                    <a class="item" data-tab="rank" id = 'tab-rank' >Rank</a>
                </div>

                <div class="ui bottom attached tab segment" data-tab="overview" id = 'overview-content' ></div>
                <div class="ui bottom attached tab segment" data-tab="problem" id = 'problem-content' ></div>
                <div class="ui bottom attached tab segment" data-tab="clarification"></div>
                <div class="ui bottom attached tab segment" data-tab="submission"></div>
                <div class="ui bottom attached tab segment" data-tab="rank"></div>
            </div>
            
        </div>
    </div>

    <script>
        var start_time = new Date('{{ contest.start_time }}');
        var end_time = new Date('{{ contest.end_time}}' );

        function get_progress_text(){
            let c = Math.abs(cur);
            let hour =  Math.floor(c / 3600); c %= 3600;
            let min = Math.floor(c / 60); c %= 60;
            let smin = String( min );
            let sc = String( c );
            if( smin.length < 2 ) smin = "0" + smin;
            if( sc.length < 2 ) sc = "0" + sc;
            return " ( " + String( hour ) + ":" + smin + ":" + sc + " )";
        }
        var total = parseInt({{ (contest.end_time - contest.start_time).total_seconds() }});
        var cur = parseInt({{ (now - contest.start_time).total_seconds() }});
        var base = cur;
        $('#runtime-progress').progress({
            total : total,
            onSuccess: function(){
                if( base < total )
                    location.reload();
            },
        });
        function UpdateTimer(){
            $('#runtime-progress').progress( 'update progress' , cur ++ );
            cur = Math.min( cur , total );
            if( cur == 0 ){
                location.reload();
                return;
            }
            $('#time-show').text( get_progress_text() );
            if( cur < total )
                setTimeout( "UpdateTimer()" , 1000 );
        }
        UpdateTimer();
        $('.contest.detail .menu .item').tab({
            cache: true,
            apiSettings: {
                mockResponseAsync: function(settings,callback) {
                    var response = {
                        overview  : '{{ url( "contest-overview" , args = ( contest.pk , ) ) }}',
                        problem : '{{ url( "contest-problem-list" , args = ( contest.pk , ) )}}',
                        clarification : 'AJAX Tab Two',
                        submission  : '{{ url( "contest-submission" , args = ( contest.pk , 1 ) ) }}',
                        rank : 'Ajax tab four',
                    };
                    $.get(
                        response[settings.urlData.tab],
                        function(result){ callback( result ); }
                    );
                },
            },
            context : 'parent',
            auto : true,
        });
        $('.contest.detail .menu .item').tab('change tab' , 'overview' );
    </script>
{% endblock content %}