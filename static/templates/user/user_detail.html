{% extends "base/base.html" %}

{% block extra_head %}
    <link href="{{ static('css/user/user_detail.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ static('echarts/echarts.min.js') }}"></script>
{% endblock extra_head %}

{% block title %}
    <title> Lutece | {{ target_user.display_name }} </title>
{% endblock title %}

{% block content %}
    <div class = 'user detail'>

        <div class = 'ui grid'>

            <div class = 'row'>

                <div class = 'eight wide column'>

                    <div class = 'ui header'>Personal Information</div> 

                    {% if user == target_user %}
                        <h5> Tell others how awesome you are </h5>
                    {% else %}
                        <h5> Basic info </h5>
                    {% endif %}

                    <div class="ui render fluid container raised segment">
                        <div class = 'ui one column grid'>
                            <div class = 'column'>
                                <div class = 'ui secondary menu'>

                                        <div class = 'item'>
                                            <div class = 'ui one column grid'>
                                                <div class = 'column'>
                                                    <img class="ui image" src= {{ gravatar_url( email = target_user.email , size = 150 ) }} >
                                                </div>
                                                {% if user == target_user %}
                                                    <div class ='column' style = 'margin-top:-15px;' >
                                                        <a href = 'https://cn.gravatar.com/' ><i class = 'hand point right outline icon'></i>Want to change photo?</a>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if user == target_user %}

                                            <div class = 'item'>

                                                <div class = 'ui grid'>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <div data-tooltip = "Display name" data-position="top left" class="ui fluid left icon input" id = 'display_name-info'>
                                                                <i class = 'user icon'> </i>
                                                                <input type ="text" value= "{{ target_user.display_name }}" maxlength = 16 >
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <div data-tooltip = "School" data-position="top left" class="ui fluid left icon input" id = 'school-info'>
                                                                <i class = 'university icon'></i>
                                                                <input class = 'disable' type ="text" value= "{{ info.school }}" maxlength = 60 >
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <div data-tooltip = "Company" data-position="top left" class="ui fluid left icon input" id = 'company-info'>
                                                                <i class = 'shopping bag icon'></i>
                                                                <input type ="text" value= "{{ info.company }}" maxlength = 32 >
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <div data-tooltip = "Location" data-position="top left" class="ui fluid left icon input" id = 'location-info'>
                                                                <i class = 'map marker alternate icon'></i>
                                                                <input type ="text" value= "{{ info.location }}" maxlength = 32 >
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>

                                            </div>


                                        {% else %}

                                            <div class = 'item'>
                                                <div class = 'ui grid'>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <i class = 'user icon'> </i> {{ target_user.display_name }}
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <i class = 'university icon'></i> {{ info.school }}
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <i class = 'shopping bag icon'></i> {{ info.company }}
                                                        </div>
                                                    </div>

                                                    <div class = 'row'>
                                                        <div class = 'column'>
                                                            <i class = 'map marker alternate icon'></i>{{ info.location }}
                                                        </div>
                                                    </div>

                                                </div>

                                            </div>


                                        {% endif %}

                                </div>
                            </div>
                            
                            <div class = 'column' style = 'margin-top:-30px;' >
                                {% if user == target_user %}
                                    <div class = 'ui divider' style = 'padding-top:20px;padding-left:20px;padding-right:20px;height:150px;'>
                                        <textarea class="ui fluid container segment" style = 'width:100%;height:150px;' id = 'about-info'>{{ info.about }}</textarea>
                                    </div>
                                {% else %}
                                    <div style = 'padding-top:20px;padding-bottom:20px;padding-left:20px;padding-right:20px;height:128px;overflow: hidden;'>
                                        <div class = 'ui divider'></div>
                                        <div class = 'ui container'>
                                            {{ info.about | nl2br }}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                        </div>
                    </div>

                </div>


                <div class = 'eight wide column'>
                    <div id="solve-analysis" style="width: 430px;height:410px;"></div>
                </div>

            </div>
        
        </div>

        <div class = 'ui two column grid'>

            <div class = 'column'>
                <div class = "label"><b>Detail</b></div>
                <div style = "margin-top:auto;">
                    {% for x in result %}
                        {% if x.1 == True %}
                            <a href = {{ url('problem-detail-view' , args = (x.0,) )}} ><div class = 'ui tiny green button aligned center' tabindex="0" style = "width:60px;height:30px;margin-top:10px;" >{{x.0}}</div></a>
                        {% else %}
                            <a href = {{ url('problem-detail-view' , args = (x.0,) )}} ><div class = 'ui tiny red button aligned center' tabindex="0" style = "width:60px;height:30px;margin-top:10px;" >{{x.0}}</div></a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class = 'column'>
                <div class = "label"><b>Recently</b></div>
                <table class = "ui basic fixed selectable padded table bordered" >
                    <thread>
                        <div class = 'status list menu'>
                            <tr>
                                <th>ID</th>
                                <th>When</th>
                                <th>Problem</th>
                                <th>Verdict</th>
                            </tr>
                        </div>
                    </thread>
                    <tbody>
                        {% for x in recently %}
                            <tr>
                                <td><a href = {{ url('submission-status-detail' , args = (x.pk,) ) }}> {{ x.pk }}</a></td>
                                <td>{{ x.submit_time.strftime('%Y-%m-%d %H:%M')  }}</td>
                                <td><a href = {{ url('problem-detail-view' , args = (x.problem.problem_id,) ) }} >{{x.problem.title}}</td>
                                <td style = 'color:{{  x.judge_status | get_judge_result_color }};'><i class = '{{ x.judge_status | get_judge_result_icon }} '></i>{{ x.judge_status }} </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id = "user-detail-error" class="ui negative message transition hidden"></div>
            </div>
        </div>
        
        {% if user == target_user %}
            <div id = 'user-detail-button' class = 'ui primary button' style = "display:grid; margin-top:18px;" > Submit </div>
        {% endif %}
    
    </div>

    <script>

        $(document).ready(function(){
            var myChart = echarts.init(document.getElementById('solve-analysis'));
            var option = {
                aria: {
                    show: true
                },
                title: {
                    text: 'Summary',
                    x: 'center'
                },
                tooltip : {
                    trigger: 'item',
                    formatter: "{b} : {c} ({d}%)"
                },
                series : [
                    {
                        type: 'pie',
                        radius: '70%',
                        selectedMode: 'single',
                        rosetype: 'angle',
                        label: {
                            normal: {
                                show: false
                            },
                            emphasis: {
                                show: false
                            }
                        },
                        data:[
                            {% for each in analysis %}
                                {
                                    value: {{ analysis[each] }},
                                    name: '{{ each.value.full }}',
                                    itemStyle:{
                                        color: '{{ each.value.color }}',
                                    },
                                },
                            {% endfor %}
                        ]
                    }
                ]
            };
            myChart.setOption(option);
        });
        
        {% if user == target_user %}
            $('#user-detail-button').click(function(){
                var about = $('#about-info').val();
                var school = $('#school-info > input').val();
                var company = $('#company-info > input').val();
                var _location = $('#location-info > input').val();
                var display_name = $('#display_name-info > input').val();
                $(this).addClass( 'disabled loading' );
                $.ajaxSetup({
                    data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                });
                $.post(
                    '{{ url("user-infomodify") }}',
                    {
                        'about' : about,
                        'school' : school,
                        'company' : company,
                        'location' : _location,
                        'display_name' : display_name
                    },
                    function(data,status){
                        if( status == 'success'  && data.status == true ){
                            location.reload();
                        }else{
                            $('#user-detail-button')
                                .removeClass( 'loading disabled primary' )
                                .addClass('red')
                            ;
                            $('#user-detail-error')
                                .empty()
                                .removeClass( 'hidden' )
                                .append(get_error_msgText( data.error_msg ))
                            ;
                        }
                    }
                )
            });
        {% endif %}

    </script>

{% endblock content %}