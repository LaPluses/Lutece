{% extends "base/base.html" %}

{% block extra_head %}
    <link href="{{ static('css/user/user_detail.css') }}" rel="stylesheet" />
    <script type="text/javascript" src="{{ static('echarts/echarts.min.js') }}"></script>
{% endblock extra_head %}

{% block title %}
    <title> Lutece | {{ target_user.display_name }} </title>
{% endblock title %}

{% block content %}
    <div class = 'user detail'>

        <div>

            <div class="ui three column grid">

                <div class = 'column'>

                    <div class = 'ui one column grid'>

                        <div class = 'column'>
                            <img class="ui small bordered image" src= {{ gravatar_url( email = target_user.email , size = 200 ) }} >
                            {% if user == target_user %}
                                <span><a href = 'https://cn.gravatar.com/' ><i class = 'hand point right outline icon'></i>Want to change photo?</a></span>
                            {% endif %}
                        </div>
                        
                        
                        <div class = 'column'>
                            <div class = 'label'><b>About</b></div>
                            <div class = 'ui form'>
                                <div class = 'field' id = 'about-info'>                                
                                    <textarea >{{ info.about }}</textarea>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <div class = 'column'>

                    <div class = 'ui header'>Personal Information</div> 

                    <h5> Tell others how awesome you are </h5>
                    
                    <br/>

                    <div class = 'ui one column grid'>

                        <div class = 'column'>
                            <div class="label"><b>School</b></div>
                            <div class="ui fluid input" id = 'school-info'>
                                <input class = 'disable' type ="text" value= "{{ info.school }}" maxlength = 32 >
                            </div>
                        </div>

                        <div class = 'column'>
                            <div class="label"><b>Company</b></div>
                            <div class="ui fluid input" id = 'company-info'>
                                <input type ="text" value= "{{ info.company }}" maxlength = 32 >
                            </div>
                        </div>

                        <div class = 'column'>
                            <div class="label"><b>Location</b></div>
                            <div class="ui fluid input" id = 'location-info'>
                                <input type ="text" value= "{{ info.location }}" maxlength = 32 >
                            </div>
                        </div>

                        <div class = 'column'>
                            <div class = "label"><b>Display name</b></div>
                            <div class="ui  fluid input" id = 'display_name-info'>
                                <input type ="text" value= "{{ target_user.display_name }}" maxlength = 16 >
                            </div>
                        </div>

                    </div>

                </div>

                <div class = 'three wide column'>
                    <div id="solve-analysis" style="width: 430px;height:410px;"></div>
                </div>
                
            </div>

            <div class = 'ui two column grid'>
                <div class = 'column'>
                    <div class = "label"><b>Detail</b></div>
                    <div style = "margin-top:13px;">
                        {% for x in result %}
                            {% if x.1 == True %}
                                <a href = {{ url('problem-detail-view' , args = (x.0,) )}} ><div class = 'ui tiny green button aligned center' tabindex="0" style = "width:60px;height:30px;margin-top:10px;" >{{x.0}}</div></a>
                            {% else %}
                                <a href = {{ url('problem-detail-view' , args = (x.0,) )}} ><div class = 'ui tiny red button aligned center' tabindex="0" style = "width:60px;height:30px;margin-top:10px;" >{{x.0}}</div></a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class = 'column'>
                    <div class = "label"><b>Recently</b></div>
                    <table class = "ui basic fixed selectable padded table bordered" >
                        <thread>
                            <div class = 'status list menu'>
                                <tr>
                                    <th>ID</th>
                                    <th>When</th>
                                    <th>Problem</th>
                                    <th>Verdict</th>
                                </tr>
                            </div>
                        </thread>
                        <tbody>
                            {% for x in recently %}
                                <tr>
                                    <td><a href = {{ url('submission-status-detail' , args = (x.pk,) ) }}> {{ x.pk }}</a></td>
                                    <td>{{ x.submit_time.strftime('%Y-%m-%d %H:%M')  }}</td>
                                    <td><a href = {{ url('problem-detail-view' , args = (x.problem.problem_id,) ) }} >{{x.problem.title}}</td>
                                    <td style = 'color:{{  x.judge_status | get_judge_result_color }};'><i class = 'ui {{ x.judge_status | get_judge_result_icon }} '></i>{{ x.judge_status }} </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div id = "user-detail-error" class="ui negative message transition hidden"></div>
                </div>
            </div>
            {% if user == target_user %}
                <div id = 'user-detail-button' class = 'ui primary button' style = "display:grid; margin-top:18px;" > Submit </div>
            {% endif %}
        </div>
    </div>

    <script>

        $(document).ready(function(){
            var myChart = echarts.init(document.getElementById('solve-analysis'));
            var option = {
                aria: {
                    show: true
                },
                title: {
                    text: 'Summary',
                    x: 'center'
                },
                tooltip : {
                    trigger: 'item',
                    formatter: "{b} : {c} ({d}%)"
                },
                series : [
                    {
                        type: 'pie',
                        radius: '70%',
                        selectedMode: 'single',
                        rosetype: 'angle',
                        label: {
                            normal: {
                                show: false
                            },
                            emphasis: {
                                show: false
                            }
                        },
                        data:[
                            {% for each in analysis %}
                                {
                                    value: {{ analysis[each] }},
                                    name: '{{ each.value.full }}',
                                    itemStyle:{
                                        color: '{{ each.value.color }}',
                                    },
                                },
                            {% endfor %}
                        ]
                    }
                ]
            };
            myChart.setOption(option);
        });
        
        {% if user != target_user %}
            $('#about-info,#school-info,#company-info,#location-info,#display_name-info').addClass( 'disabled' );
        {% else %}
            $('#user-detail-button').click(function(){
                var about = $('#about-info > textarea')[0].value;
                var school = $('#school-info > input')[0].value;
                var company = $('#company-info > input')[0].value;
                var _location = $('#location-info > input')[0].value;
                var display_name = $('#display_name-info > input')[0].value;
                $(this).addClass( 'disabled loading' );
                $.ajaxSetup({
                    data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                });
                $.post(
                    '{{ url("user-infomodify") }}',
                    {
                        'about' : about,
                        'school' : school,
                        'company' : company,
                        'location' : _location,
                        'display_name' : display_name
                    },
                    function(data,status){
                        if( status == 'success'  && data.status == true ){
                            location.reload();
                        }else{
                            $('#user-detail-button')
                                .removeClass( 'loading disabled primary' )
                                .addClass('red')
                            ;
                            $('#user-detail-error')
                                .empty()
                                .removeClass( 'hidden' )
                                .append(get_error_msgText( data.error_msg ))
                            ;
                        }
                    }
                )
            });
        {% endif %}

    </script>

{% endblock content %}